define(["config","spin.min","autosize"],function(config,Spinner,autosize){var windowId=Math.random();var searchResultsData={};var previousQuery;var firstEdit=true;var closingQuestionPunctuation="?";function getSubmitButton(){return $("#quora_submit_button")}function setupSubmitButton(){getSubmitButton().click(submitQuestion)}function submitQuestion(){var query=getQuery();addQuestionRequest(query)}function addQuestionRequest(question_text){var url=config.baseURL+"/chrome_extension_api/add_question_3RD_PARTY_POST";var spinner=new Spinner({scale:.5,color:"#fff",lines:8,width:4});var request=$.ajax({method:"POST",url:url,data:{question_text:question_text,window_id:windowId},beforeSend:function(){$("#quora_submit_button").addClass("asking");spinner.spin($("#quora_submit_button")[0])}});request.done(function(result){afterSubmitQuestion(JSON.parse(result))}).fail(function(){afterSubmitQuestion({reason:"Internal server error."})}).always(function(){spinner.stop()})}function afterSubmitQuestion(result){$("#quora_submit_button").removeClass("asking");$(".quora_message").empty();if(result.qid){var link=$("<a>").append("<span>Added question to Quora: </span>"+getSearchInput().val()).attr("target","_blank").attr("href",result.url+"?ref=gc");$(".quora_message").html(link).removeClass("failure").addClass("success");getSearchInput().val("")}else{$(".quora_message").html(result.reason).removeClass("success").addClass("failure")}}function getSearchInput(){return $("#quora_search_input")}function setupSearchInput(){getSearchInput().keydown(inputKeydown).keyup(inputKeyup).keypress(inputKeypress).blur(inputBlur);autosize(getSearchInput())}function inputBlur(){hideDropdown()}function inputKeydown(evt){var code=evt.keyCode;if(code==40){down();return false}else if(code==38){up();return false}else if(code==13){submitQuestion();return preventSubmit(evt)}else if(code==9){return false}return true}function inputKeyup(){onInputChange();$(".quora_message").empty().removeClass("success").removeClass("failure");return false}function preventSubmit(evt){evt.stopPropagation();evt.preventDefault();return false}function inputKeypress(evt){if(evt.code==13){return preventSubmit(evt)}}function getQuery(){return getSearchInput().val().trim()}function onInputChange(){var query=getQuery();if(previousQuery==query){return}previousQuery=query;if(!query){hideDropdown()}beautifyOnChange();suggestForQuery(query)}function beautifyOnChange(){var cursorDelta=0;if(firstEdit){firstEdit=false;var query=getQuery()+closingQuestionPunctuation;setInputVal(capitalize(query),cursorDelta)}}function setInputVal(val,cursorDelta){var searchInput=getSearchInput();var selStart=searchInput[0].selectionStart,selEnd=searchInput[0].selectionEnd;if(cursorDelta){selStart+=cursorDelta;selEnd+=cursorDelta}searchInput.val(val);if(val.length>0){searchInput[0].setSelectionRange(selStart,selEnd)}}function capitalize(query){if(!query){return query}var startPos=0;query=query.slice(0,startPos)+query.charAt(startPos).toUpperCase()+query.slice(startPos+1);return query}function suggestForQuery(query){var q=encodeURIComponent(query);var url=config.baseURL+"/chrome_extension_api/query_suggestions?q="+q;url+="&___W2_windowId="+windowId;url+="&data="+encodeURIComponent("{}");var request=$.ajax({url:url,cache:false});request.done(function(results){processSearchResponse(JSON.parse(results))})}function hasResults(){if(!searchResultsData){return false}var items=searchResultsData.items;if(!items){return false}return items.length}function processSearchResponse(result){var resultsFrame=getResultsFrame();if(resultsFrame.length){resultsFrame.html(resultsToDOM(result))}else{resultsFrame=setupResultsFrame(result)}setupListItems(resultsFrame,result);if(hasResults()){showDropdown()}else{hideDropdown()}}function setupResultsFrame(result){var width=$(".search_bar").width();var resultsFrame=$("<div>").attr("id","results_frame").addClass("SearchSuggestions hover_menu_contents").append(resultsToDOM(result));$("#results_shell").html(resultsFrame);return resultsFrame}function resultsToDOM(results){var resultsDOM=[];var less_results=results.slice(0,3);less_results.forEach(function(result,i){var link=$("<a>").append($(result.html).html()).attr("target","_blank").attr("href",result.url+"?ref=gc");resultsDOM.push($("<li>").attr("id","_"+i).append(link))});return resultsDOM}function setupListItems(resultsFrame,result){var items=resultsFrame.find("li");searchResultsData={items:items,focusedIndex:null};items.each(function(i,item){$(item).mouseover(function(){setFocusIndex(i)});$(item).mousedown(function(){window.open(result[i].url+"?ref=gc")})})}function getResultsFrame(){return $("#results_frame")}function showDropdown(){var frame=getResultsFrame();if(!frame.hasClass("is_shown")){frame.addClass("is_shown").addClass("fade_in")}}function hideDropdown(){var frame=getResultsFrame();frame.removeClass("fade_in").addClass("fade_out");setTimeout(function(){frame.removeClass("is_shown").removeClass("fade_out")},150)}function up(){var data=searchResultsData;var index=data.focusedIndex;var length=data.items.length;if(index===null){setFocusIndex(length-1)}else if(0===index){setFocusIndex(null)}else if(0<index){setFocusIndex(index-1)}}function down(){var data=searchResultsData;var index=data.focusedIndex;var length=data.items.length;if(index===null){setFocusIndex(0)}else if(index<length-1){setFocusIndex(index+1)}else if(index==length-1){setFocusIndex(null)}}function setFocusIndex(index){var data=searchResultsData;var length=data.items.length;if(!length){return}for(var i=0;i<length;i++){var item=$(data.items[i]);if(index!==null&&item.attr("id").endsWith("_"+index)){item.addClass("selected")}else{item.removeClass("selected")}}data.focusedIndex=index}function go(){var data=searchResultsData;var index=data.focusedIndex;if(index!==null&&data&&data.items){$(data.items[index]).mousedown()}else{var query=getQuery();if(!query){return}var q=encodeURIComponent(query).replace(/%20/g,"+");var url=config.baseURL+"/search?q="+q;window.open(url)}}var SearchBar={setup:function(){setupSearchInput();setupSubmitButton()},getSearchInput:getSearchInput,inputKeyup:inputKeyup};return SearchBar});
